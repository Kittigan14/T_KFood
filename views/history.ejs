<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</title>
  <link rel="stylesheet" href="/css/base.css" />
  <link rel="stylesheet" href="/css/history.css" />
</head>

<body>
  <div class="container">
    <h2>üì¶ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
    <div id="history-list">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    <button onclick="window.location.href='/'" class="btn-back">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
  </div>

  <script>
    const statusText = {
      completed: "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß",
      cancelled: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
      pending: "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£",
      accepted: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß",
      cooking: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°",
      delivering: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á"
    };

    async function loadHistory() {
      try {
        const res = await fetch("/api/history");
        const data = await res.json();

        const container = document.getElementById("history-list");

        if (!data.success || data.orders.length === 0) {
          container.innerHTML = "<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>";
          return;
        }

        container.innerHTML = data.orders.map(order => `
        <div class="order-card">
          <div class="order-header">
            <h3>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ #${order.order_id}</h3>
            <span class="status ${order.order_status}">
                ${statusText[order.order_status] || order.order_status}
            </span>
          </div>

          <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${new Date(order.created_at).toLocaleDateString("th-TH")}</p>
          <p><strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</strong> ${(order.final_amount + 25 || 0).toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
          ${order.employee_name ? `<p><strong>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</strong> ${order.employee_name}</p>` : ''}

          <div class="order-items">
            ${order.items.map(item => `
              <div class="item">
                <img src="/images/${item.image_url || "default.png"}" 
                     alt="${item.product_name}" 
                     onerror="this.src='/images/default.png'" />
                <div class="item-info">
                  <p class="product-name">${item.product_name}</p>
                  <p class="product-detail">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${item.quantity} √ó ${item.price} ‡∏ö‡∏≤‡∏ó</p>
                </div>
              </div>
            `).join("")}
          </div>

          ${order.reviews && order.reviews.length > 0 ? `
            <div class="reviews">
              <h4>‚≠ê ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h4>
              ${order.reviews.map(r => `
                <div class="review">
                  <p>"${r.comment}" ‚≠ê ${r.rating}</p>
                  <small>${new Date(r.created_at).toLocaleDateString("th-TH")}</small>
                </div>
              `).join("")}
            </div>
          ` : ""}
        </div>
      `).join("");
      } catch (err) {
        console.error("‡πÇ‡∏´‡∏•‡∏î history ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", err);
        document.getElementById("history-list").innerHTML = "<p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>";
      }
    }

    loadHistory();
  </script>

</body>
</html>